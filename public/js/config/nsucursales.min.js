function HoneySuc() {
	var that = this, tabla = $('<tbody></tbody>').attr('id', 'tbody_nsuc'), token = $("#token_").val();
	var btn_insert = $("#btn_crensuc"), btn_update = $("#btn_updnsuc"), btn_delte = $("#btn_delnsuc");

	$("#btn_reg").click(function(){ that.Muestra(1); that.Panel(2); });

	$(document).on('click', '#btn_editnsuc', function(e){ e.preventDefault(); that.Muestra(2); that.BuscaDatos(this.value, 2); });

	$(document).on('click', '#btn_deletensuc', function(e){ e.preventDefault(); that.Muestra(3); that.BuscaDatos(this.value, 2); });

	$("#btn_table").click(function(){ that.Panel(1); });


	btn_insert.click(function(){ that.SubirImagen(1); })

	btn_update.click(function(){ that.SubirImagen(2); })

	btn_delte.click(function(){ 
		datas = {  idkey : clv_nsuc.value, img_ruta: null, hrs : hrs_nsuc.value, id_suc : $("#suc").val(), TipoCrud: 'Eliminar' };
        that.Ajax("/nuestrassucursales/"+clv_nsuc.value+"", "DELETE", datas);
	});

	$(document).on('click', '.pagination a', function(e){
		e.preventDefault();
		var page = $(this).attr('href').split('page=')[1];
		$.ajax({
			url: '/nuestrassucursales',
			data: { page : page },
			type: 'GET',
			dataType: 'json',
			success : function(data){
				that.CargaDatosTabla(page, data);	
			}
		});	
	});

	that.CargaTabla = function(value){
		$("#panelbody").append($("#div-table").show());
		tabla.empty();
		$.get('/nuestrassucursales', function(response){
			if(value == 1){ that.CargaDatosTabla(); }else{ that.CargaDatosTabla(1, response); }	
		});
	}

	that.SubirImagen = function(value){
		var Image = $("#ruta_nsuc").prop("files")[0];
		var form_data = new FormData();
		form_data.append("Vch_Ruta", Image);
		$.ajax({
			url: "/uploadimgnsuc",
			headers: {'X-CSRF-TOKEN' : token },
			type: 'POST',
			data: form_data,
			processData: false,
            contentType: false,
            success : function(response){
            	$(response).each(function(){
            		var datas = null;
            		if(value == 1){
            			datas = {  idkey : clv_nsuc.value, img_ruta: this.nombre, hrs : hrs_nsuc.value, id_suc : $("#suc").val(), TipoCrud: 'Insertar' };
            			that.Ajax("/nuestrassucursales", "POST", datas);
            		}else{
            			datas = {  idkey : clv_nsuc.value, img_ruta: this.nombre, hrs : hrs_nsuc.value, id_suc : $("#suc").val(), TipoCrud: 'Actualizar' };
            			that.Ajax("/nuestrassucursales/"+clv_nsuc.value+"", "PUT", datas);	
            		}
            	});
            },
            error : function(){
            	alert("Error en el servidor");
            }
		});
	}

	that.BuscaDatos = function(value, opc){
		$.ajax({
			url: '/nuestrassucursales/'+value+'/edit',
			type: 'GET',
			dataType: 'json',
			success : function(response){
				that.Panel(opc, response);
			},
			error : function(){
				alert("error");
			}
		});
	}

	that.CargaDatosTabla = function(pagination = 0, data = null){
		var page = (pagination == 0) ? page = 1 : page = pagination;
		tabla.empty();
		$.ajax({
			url: '/tablensuc',
			data: { page : page },
			type: 'GET',
			dataType: 'json',
			beforeSend : function(){
				$('.preloader').show();
			},
			success : function(response){
				$(response.data).each(function(){
					tabla.append("<tr><td>"+this.id+"</td>"+
					"<td><img src='images/"+this.ruta+"' style='width:150px;'></td><td>"+this.horarios+"</td><td>"+this.Sucursal+"</td>"+
					"<td><button class='btn btn-success' id='btn_editnsuc' value="+this.id+">Editar</button></td>"+
					"<td><button class='btn btn-danger' id='btn_deletensuc' value="+this.id+">Eliminar</button></td></tr>");
				});
				$("#tablesuc").append(tabla);
				if(data != null){ $("#render").html(data); }
				$('.preloader').hide();	
			}
		});	
	}

	that.Combo = function(){
		var suc = $("#suc").empty();
		$.get('/combonsuc', function(response){
			$(response).each(function(){
				var option = $(document.createElement('option'));
				option.val(this.Sml_IdSucursal);
				option.text(this.Sucursal);
				$(suc).append(option);
			});
		});
	}

	that.Panel = function(value, data = null){
		if(value ==1){
			$("#div-reg").hide();
			return that.CargaTabla(0);			
		}else{
			if(value == 2){
				$("#div-table").hide();
				$('input[type = "text"]').val('');
				$('textarea').val('');
				$('input[type = "file"]').val('');
				if(data != null){
					$(data).each(function(){
						$("#clv_nsuc").val(this.id); $("#hrs_nsuc").val(this.horarios);
						$('#suc option:contains('+this.Sucursal+')').attr('selected', 'selected');
					});
				}
				return $("#panelbody").append($("#div-reg").show());
			}else{
				$("#div-reg").hide();
				return that.CargaTabla(2);
			}
		}	
	}

	that.Ajax = function(Route, Types, Data){
		$.ajax({
			url: Route,
			headers: {'X-CSRF-TOKEN' : token },
			type: Types,
			dataType: 'json',
			data: Data,
			success : function(response){
				$(response).each(function(){
					if(this.Bln_Bandera == 1){
						if($("#alert_cruds").hasClass('alert-danger')){
							$("#alert_cruds").removeClass('alert-danger');
							$("#alert_cruds").addClass('alert-success');			
						}
						$("#alert_cruds").fadeIn();
						$("#alert_cruds #txt_response").text(this.Vch_Mensaje);	
					}else{
						if($("#alert_cruds").hasClass('alert-success')){
							$("#alert_cruds").removeClass('alert-success');
							$("#alert_cruds").addClass('alert-danger');	
						}
						$("#alert_cruds").fadeIn();
						$("#alert_cruds #txt_response").text(this.Vch_Mensaje);
					}
					that.Panel(3);
				});
			},
			error : function(){
				alert("Error");
			}
		});	
	}

	that.Muestra = function(value){
		btn_insert = (value == 1) ? btn_insert.show() : btn_insert.hide();
		btn_update = (value == 2) ? btn_update.show() : btn_update.hide();
		btn_delte = (value == 3) ? btn_delte.show() : btn_delte.hide();
	}
}

var suc = new HoneySuc();

$(document).ready(function(){
	suc.CargaTabla(0);
	suc.Combo();
});